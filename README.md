# åŸºäº LightGBM çš„äººå£æµåŠ¨é¢„æµ‹æ¨¡å‹ï¼Œç”¨äºé¢„æµ‹ä¸åŒäººç¾¤ç±»å‹åœ¨åŸå¸‚é—´çš„æµåŠ¨æ–¹å‘å’Œè§„æ¨¡ã€‚é‡‡ç”¨å¬å›æ¨¡å¼(Recall Mode)ï¼Œç»“åˆåŠ¨æ€åŸå¸‚ç‰¹å¾å’Œå†å²æµåŠ¨æ•°æ®è®­ç»ƒæ¨¡å‹ã€‚
```
å¸¸ç”¨å‘½ä»¤ä¸æµç¨‹
uv run generate_data.py
uv run fast_train.py --end_year 2020
uv run evaluate.py --year 2020 --sample 10000
æˆ–è€…æŒ‡å®šæ¨¡å‹å‚æ•°
uv run evaluate.py --year 2020 --model output/checkpoints/model_2020_round_50.txt --sample 5000
```


```
æœåŠ¡å™¨ç‰ˆæœ¬
æœ¬åœ°ï¼š ssh -p 2023 -R 10080:127.0.0.1:7890 -N wxj@10.82.1.210
æœåŠ¡å™¨ï¼š
cd /data1/wxj/Recall_city_project
unset http_proxy https_proxy all_proxy HTTP_PROXY HTTPS_PROXY ALL_PROXY
export http_proxy="http://127.0.0.1:10080"
export https_proxy="http://127.0.0.1:10080"
export HTTP_PROXY="http://127.0.0.1:10080"
export HTTPS_PROXY="http://127.0.0.1:10080"
curl -v https://api.github.com  
```

# äººå£æµåŠ¨é¢„æµ‹æ¨¡å‹

# TODO
æ ¸å¿ƒæ”¹è¿›ç­–ç•¥

ã€okkã€‘ä¿®æ”¹evaluateçš„ground truth ç›®å‰éç©ºçš„äº‹å®é€‰æ‹©åŸå¸‚å¹³å‡queryæœ‰14ä¸ª  å®é™…ä¸Šåªå…³å¿ƒtop10æ­£ç¡®æ€§

ã€okkã€‘è®¾ç½®æ—©åœæ›´æ…¢ éªŒè¯æ›´å……åˆ†

è°ƒæ•´ LightGBM å‚æ•° (é’ˆå¯¹ Top K ä¼˜åŒ–)
æ—¢ç„¶åªå…³å¿ƒ Top 10 å‡†ä¸å‡†ï¼Œã€‚ä½†åœ¨äºŒåˆ†ç±»æ¡†æ¶ä¸‹ï¼ˆä¸è¦ç”¨LambdaRankï¼‰ï¼Œå¯ä»¥é€šè¿‡åŠ å¤§ Top æ ·æœ¬æƒé‡æ¥å®ç°ã€‚
ä¿®æ”¹æ–‡ä»¶: fast_train.py (åœ¨ train_batch_mode å¾ªç¯å†…)
        # åŠ è½½ -> æ‰“ä¹±
        df_train = load_data_batch(batch_years, shuffle=True)
        # ... ç‰¹å¾å¯¹é½ä»£ç  ...
        # ğŸ”¥ æ¿€è¿›çš„æƒé‡ç­–ç•¥
        # Top 10 (Label=1.0): æƒé‡ 20
        # Rank 11-20 (Label=0.1): æƒé‡ 5 (è®©æ¨¡å‹é‡è§†è¿™äº›"å·®ç‚¹é€‰å¯¹"çš„é”™é¢˜)
        # å…¶ä»– (Label=0.0): æƒé‡ 1
        weights = df_train['Label'].apply(lambda x: 20.0 if x > 0.9 else (5.0 if x > 0.05 else 1.0))
        train_ds = lgb.Dataset(
            df_train[feats], 
            label=df_train['Label'], 
            weight=weights,  # <--- ç¡®ä¿ä¼ å…¥ weights
            # ...
        )

ã€okkã€‘å¯è§†åŒ–å¢å¼º (User Req 1): åœ¨è®­ç»ƒç»“æŸæ—¶è¾“å‡º Feature Importance å›¾ç‰‡ã€‚

ã€okkã€‘è®­ç»ƒç­–ç•¥é‡æ„ (User Req 2): æ”¾å¼ƒé€å¹´å¢é‡è®­ç»ƒï¼Œæ”¹ä¸º Batch è®­ç»ƒã€‚
åŸå› : é€å¹´è®­ç»ƒ (init_model) åœ¨ LightGBM ä¸­ä¼šå¯¼è‡´"é—å¿˜ç¾éš¾"ã€‚2001å¹´çš„è§„å¾‹åˆ°2010å¹´è™½ç„¶æœ‰æ¼‚ç§»ï¼Œä½†åŸºç¡€è§„å¾‹ï¼ˆå¦‚è·ç¦»è¡°å‡ã€çœå†…æµåŠ¨ï¼‰æ˜¯ä¸å˜çš„ã€‚æˆ‘çš„éœ€æ±‚æ˜¯åªæŒ‡å®šç»“æŸå¹´ä»½ æ¯”å¦‚--2012  é‚£ä¹ˆ2001-2003 æ¯ä¸‰å¹´ä¸€ä¸ªbatchè¿›è¡Œè®­ç»ƒ  éªŒè¯é›†æ°¸è¿œæ˜¯ç»“æŸå¹´ä»½çš„å‰2å¹´å³2010å…¨é‡å’Œ2011å…¨é‡  ç„¶å2012è¿™ä¸€å¹´å…¨é‡ä½œä¸ºevaluateçš„æµ‹è¯•é›†ã€‚

ã€okkã€‘è´Ÿæ ·æœ¬ç­–ç•¥é©å‘½ (User Req 5 - æœ€å…³é”®):
å¼•å…¥"çœå†…å¹²æ‰°": ç»å¤§å¤šæ•°æµåŠ¨å‘ç”Ÿåœ¨çœå†…ã€‚æ¨¡å‹å¿…é¡»å­¦ä¼šåŒºåˆ†"çœä¼šåŸå¸‚"å’Œ"çœå†…å…¶ä»–åŸå¸‚"ã€‚
å¼•å…¥"æ’åé åå¹²æ‰°" (Rank 11-20): ä½ å¸Œæœ› Recall@10 é«˜ï¼Œé‚£ä¹ˆ Rank 11-20 å°±æ˜¯æœ€å¼ºçš„å¹²æ‰°é¡¹ï¼ˆHard Negativeï¼‰ã€‚æŠŠå®ƒä»¬æ ‡è®°ä¸ºè´Ÿæ ·æœ¬ï¼ˆLabel=0ï¼‰ï¼Œå¼ºè¿«æ¨¡å‹æŠŠå®ƒä»¬æ’åœ¨ Top 10 ä¹‹å¤–ã€‚  ç„¶åä¹Ÿéœ€è¦æœ¬çœå†…éå‡ºå‘åŸå¸‚éçƒ­é—¨åŸå¸‚çš„æ‰€æœ‰çœå†…å…¶å®ƒåŸå¸‚ ä½œä¸ºè´Ÿæ ·æœ¬
æœ€å ä¿è¯éšæœºä»å‰©ä¸‹çš„å…¨å›½åŸå¸‚éšæœºé‡‡æ ·ä½œä¸ºè´Ÿæ ·æœ¬
æœ€åä¿è¯è®­ç»ƒçš„æ—¶å€™ ä¸€ä¸ªquery top10ä½œä¸ºæ­£æ ·æœ¬  å‰©ä¸‹å¤§çº¦40ä¸ªåŸå¸‚ä½œä¸ºè´Ÿæ ·æœ¬


ã€okkã€‘ç‰¹å¾å·¥ç¨‹ä¼˜åŒ– (User Req 4): å¢åŠ  is_same_province (æ˜¯å¦åŒçœ) ç‰¹å¾ã€‚è¿™æ˜¯ä¸€ä¸ªå¼ºç‰¹å¾ã€‚

ã€okkã€‘æ¨¡å‹å‚æ•°è°ƒæ•´ (User Req 3): å¢åŠ æ ‘çš„æ·±åº¦ï¼Œå› ä¸ºäººå£æµåŠ¨æ˜¯éçº¿æ€§çš„å¤æ‚å…³ç³»ã€‚

```
å…¶ä¸­è®­ç»ƒé›†åŠ è½½.dbæ¯å¹´çš„æ•°æ®schemaéƒ½æ˜¯Year Month Type_ID Birth_Region From_City Total_Count Stay_Prob Outflow_Count To_Top1 To_Top1_Count To_Top2 To_Top2_Count To_Top3 To_Top3_Count To_Top4 To_Top4_Count To_Top5 To_Top5_Count To_Top6 To_Top6_Count To_Top7 To_Top7_Count To_Top8 To_Top8_Count To_Top9 To_Top9_Count To_Top10 To_Top10_Count To_Top11 To_Top11_Count To_Top12 To_Top12_Count To_Top13 To_Top13_Count To_Top14 To_Top14_Count To_Top15 To_Top15_Count To_Top16 To_Top16_Count To_Top17 To_Top17_Count To_Top18 To_Top18_Count To_Top19 To_Top19_Count To_Top20 To_Top20_Count 2002 12 F_30_EduHi_Service_IncML_Unit_5119 5119 å·´ä¸­(5119) 6 0.990736 6 æˆéƒ½(5101) 2 é‡åº†(5000) 0 è¾¾å·(5117) 0 å¹¿å…ƒ(5108) 0 ç»µé˜³(5107) 0 ä¸Šæµ·(3100) 0 å—å……(5113) 0 åŒ—äº¬(1100) 0 é‚å®(5109) 0 ä¹Œé²æœ¨é½(6501) 0 æ”€æèŠ±(5104) 0 å¾·é˜³(5106) 0 å¹¿å®‰(5116) 0 æ˜†æ˜(5301) 0 å®œå®¾(5115) 0 å¤©æ´¥(1200) 0 è¥¿å®‰(6101) 0 æ³¸å·(5105) 0 æ±‰ä¸­(6107) 0 è´µé˜³(5201) 0 2020 12 F_40_EduLo_Wht_IncMH_Split_4453 4453 äº‘æµ®(4453) 249 0.959849 239 å¹¿å·(4401) 59 æ·±åœ³(4403) 54 ä½›å±±(4406) 39 è‚‡åº†(4412) 20 æ±Ÿé—¨(4407) 7 æƒ å·(4413) 7 æ¹›æ±Ÿ(4408) 5 æ¸…è¿œ(4418) 2 ä¸Šæµ·(3100) 2 æµ·å£(4601) 2 ç æµ·(4404) 2 é˜³æ±Ÿ(4417) 2 éŸ¶å…³(4402) 2 é‡åº†(5000) 2 åŒ—äº¬(1100) 2 èŒ‚å(4409) 0 å—å®(4501) 0 æ±•å¤´(4405) 0 æ¢§å·(4504) 0 æ²³æº(4416) 0 2012 12 F_40_EduLo_Wht_IncH_Unit_4502 4502 æŸ³å·(4502) 69 0.812853 56 å—å®(4501) 17 æ¡‚æ—(4503) 15 é‡åº†(5000) 2 ä¸Šæµ·(3100) 2 æ¢§å·(4504) 2 ç™¾è‰²(4510) 2 ç‰æ—(4509) 2 è´µæ¸¯(4508) 2 æµ·å£(4601) 0 åŒ—äº¬(1100) 0 åŒ—æµ·(4505) 0 æ·±åœ³(4403) 0 è´µé˜³(5201) 0 è´ºå·(4511) 0 é’¦å·(4507) 0 æ˜†æ˜(5301) 0 å¹¿å·(4401) 0 ä¹Œé²æœ¨é½(6501) 0 é˜²åŸæ¸¯(4506) 0 å¤©æ´¥(1200) 0





ç„¶åå…³äºåŸå¸‚ä¿¡æ¯ æ¯å¹´éƒ½æœ‰337ä¸ªåŸå¸‚å±æ€§ ä¾‹å¦‚{"city_id": "1301", "city_name": "çŸ³å®¶åº„", "basic_info": {"tier": 3, "coordinates": [114.51, 38.04], "area_sqkm": 3738.0}, "economy": {"gdp_per_capita": 61000.4, "cpi_index": 102.5, "unemployment_rate": 0.046, "industry_sectors": {"agriculture": {"share": 0.175, "avg_wage": 3117, "vacancy_rate": 0.08}, "manufacturing": {"share": 0.38, "avg_wage": 6833, "vacancy_rate": 0.11}, "traditional_services": {"share": 0.302, "avg_wage": 3531, "vacancy_rate": 0.07}, "modern_services": {"share": 0.143, "avg_wage": 8968, "vacancy_rate": 0.04}}}, "demographics": {"age_structure": {"16_24": 0.093, "25_34": 0.145, "35_49": 0.264, "50_60": 0.207, "60_plus": 0.291}, "sex_ratio": 105.1}, "living_cost": {"housing_price_avg": 13485.0, "rent_avg": 747.0, "daily_cost_index": 1.03}, "public_services": {"medical_score": 0.73, "education_score": 0.68, "transport_convenience": 0.6, "avg_commute_mins": 35}, "social_context": {"population_total": 5823559, "migrant_stock_distribution": {"5000": 0.021, "3100": 0.021, "3500": 0.007}}, "ground_truth_cache": {"inflow_index_last_year": 3.29}}





ç„¶åcity edgeçš„jsonlä¾‹å¦‚{"source_id": "1301", "target_id": "1302", "w_geo": 97.2, "w_dialect": 1.35, "w_admin": 0.0, "w_transport": 0.0} æ˜¯å›ºå®šçš„ ä¹Ÿåªéœ€è¦w_geoå’Œw_dialectè·ç¦»ã€‚ ç„¶ååŸå¸‚èŠ‚ç‚¹å°±æ˜¯{"city_id": "1301", "name": "çŸ³å®¶åº„"}ã€‚ç„¶åç‰¹å¾äººçš„å±æ€§å°±æ˜¯DIMENSIONS = {

    'D1': {'name': 'æ€§åˆ«', 'values': ['M', 'F']},

    'D2': {'name': 'ç”Ÿå‘½å‘¨æœŸ', 'values': ['16-24', '25-34', '35-49', '50-60', '60+']},

    'D3': {'name': 'å­¦å†', 'values': ['EduLo', 'EduMid', 'EduHi']},

    'D4': {'name': 'è¡Œä¸šèµ›é“', 'values': ['Agri', 'Mfg', 'Service', 'Wht']},

    'D5': {'name': 'ç›¸å¯¹æ”¶å…¥', 'values': ['IncL', 'IncML', 'IncM', 'IncMH', 'IncH']},

    'D6': {'name': 'å®¶åº­çŠ¶æ€', 'values': ['Split', 'Unit']},

}

```






## âœ¨ ä¸»è¦ç‰¹ç‚¹

- **å¹´åº¦åŠ¨æ€åŸå¸‚ç‰¹å¾**: æ”¯æŒ2000-2020å¹´æ¯å¹´åŸå¸‚å±æ€§æ›´æ–°
- **å†å²æµåŠ¨ç‰¹å¾**: åˆ©ç”¨å†å²æ•°æ®æå‡é¢„æµ‹å‡†ç¡®æ€§
- **æ··åˆè´Ÿæ ·æœ¬ç­–ç•¥**: å›°éš¾è´Ÿæ ·æœ¬(å¤§åŸå¸‚) + éšæœºè´Ÿæ ·æœ¬ï¼Œæ¯”ä¾‹1:5
- **äºŒåˆ†ç±»å¬å›æ¨¡å‹**: ä½¿ç”¨ binary_logloss è®­ç»ƒï¼Œä¼˜åŒ– Recall@K
- **CPU/GPUæ”¯æŒ**: çµæ´»é€‰æ‹©è®­ç»ƒåç«¯

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒè®¾ç½®
```bash
# å®‰è£…ä¾èµ–
uv pip install -e .
```

### 2. ç”Ÿæˆè®­ç»ƒæ•°æ®
```bash
uv run main.py
```

### 3. è®­ç»ƒæ¨¡å‹
```bash
# CPUè®­ç»ƒ
uv run train.py

# GPUè®­ç»ƒ
uv run train.py --gpu

# å¿«é€Ÿæµ‹è¯•(åªè®­ç»ƒåˆ°2010å¹´)
uv run train.py --end_year 2010
```

### 4. è¯„ä¼°æ¨¡å‹
```bash
uv run evaluate.py
```

è¯¦ç»†ä½¿ç”¨è¯´æ˜è¯·æŸ¥çœ‹ [ä½¿ç”¨æŒ‡å—.md](ä½¿ç”¨æŒ‡å—.md)

---

## ğŸ“Š ç‰¹å¾è¯´æ˜

### ç‰¹å¾Schema

ä¿å­˜åˆ° Parquet çš„åˆ—(~36ä¸ª):

| ç±»åˆ« | åˆ—å | ç±»å‹ | è¯´æ˜ |
|------|------|------|------|
| **åŸºç¡€æ ‡è¯†** | Year | int16 | å¹´ä»½ |
| | Type_ID_orig | str | åŸå§‹Type_ID(ç”¨äºå†å²ç‰¹å¾åŒ¹é…) |
| | From_City_orig | str | åŸå§‹å‡ºå‘åŸå¸‚ |
| | From_City | int16 | å‡ºå‘åŸå¸‚ID |
| | To_City | int16 | ç›®æ ‡åŸå¸‚ID |
| | qid | int32 | æŸ¥è¯¢ç»„ID |
| **æ ‡ç­¾** | Rank | int16 | åŸå§‹æ’å |
| | Label | float32 | äºŒåˆ†ç±»æ ‡ç­¾(Top10=1.0, Top11-20=0.1, è´Ÿæ ·æœ¬=0.0) |
| | Flow_Count | int32 | å®é™…æµé‡ |
| **Type_IDç‰¹å¾** | gender, age_group, education, industry, income, family | int8 | 6ç»´äººå£ç±»å‹ç‰¹å¾ |
| **åŸå¸‚ç‰¹å¾** | geo_distance, dialect_distance | float32 | åœ°ç†è·ç¦»å’Œæ–¹è¨€è·ç¦» |
| | *_ratio (21ä¸ª) | float32 | åŸå¸‚å±æ€§å·®å¼‚ratio(To/From) |
| **å†å²ç‰¹å¾** | Hist_Flow_Log | float32 | log(å»å¹´æµé‡+1) |
| | Hist_Rank | int16 | å»å¹´æ’å |
| | Hist_Label | float32 | å»å¹´Label |
| | Hist_Share | float32 | å»å¹´æµé‡å æ¯” |
| | Hist_Label_1y | int16 | è¿‘1å¹´Label |
| | Hist_Label_3y_avg | float32 | è¿‘3å¹´å¹³å‡Label |
| | Hist_Label_5y_avg | float32 | è¿‘5å¹´å¹³å‡Label |

### è®­ç»ƒç‰¹å¾(~36ä¸ª)

æ’é™¤ä»¥ä¸‹åˆ—åç”¨äºè®­ç»ƒ:
```python
exclude_cols = [
    'Label',        # æ ‡ç­¾
    'To_City',      # ç›®æ ‡åŸå¸‚
    'Flow_Count',   # æ³„éœ²ç‰¹å¾
    'Rank',         # æ³„éœ²ç‰¹å¾
    'Total_Count',   # å¯èƒ½æ³„éœ²
    'qid',          # æŸ¥è¯¢ç»„ID
    'Type_ID_orig', 'From_City_orig'  # ä¸­é—´åˆ—
]
```

å®é™…ä½¿ç”¨çš„ç‰¹å¾:
- Year (1ä¸ª)
- Type_IDæ‹†è§£ç‰¹å¾ (6ä¸ª)
- From_City (1ä¸ª, int16)
- åŸå¸‚ç‰¹å¾ (23ä¸ª: 2ä¸ªè·ç¦» + 21ä¸ªratio)
- å†å²ç‰¹å¾ (7ä¸ª)

---

## ğŸ“ˆ æ¨¡å‹æ¶æ„

### è®­ç»ƒæµç¨‹
1. ä»DuckDBåŠ è½½åŸå§‹äººå£æµåŠ¨æ•°æ®
2. ä¸ºæ¯å¹´åŠ è½½å¯¹åº”çš„åŸå¸‚ç‰¹å¾æ•°æ®(å¦‚2015å¹´ç”¨cities_2015.jsonl)
3. ç”Ÿæˆæ··åˆè´Ÿæ ·æœ¬(50ä¸ªå›°éš¾è´Ÿæ ·æœ¬ + 50ä¸ªéšæœºè´Ÿæ ·æœ¬)
4. è¿›è¡Œç‰¹å¾å·¥ç¨‹(äººå£ç±»å‹ã€åŸå¸‚ç‰¹å¾ã€å†å²ç‰¹å¾)
5. ä½¿ç”¨LightGBMäºŒåˆ†ç±»è®­ç»ƒ(binary_logloss)

### é¢„æµ‹æµç¨‹
ç»™å®šä¸€ä¸ªæŸ¥è¯¢(Year, Type_ID, From_City)ï¼Œå¯¹337ä¸ªå€™é€‰åŸå¸‚å…¨éƒ¨æ‰“åˆ†:
1. ç”ŸæˆæŸ¥è¯¢-åŸå¸‚å¯¹ç‰¹å¾
2. ä½¿ç”¨LightGBMæ¨¡å‹é¢„æµ‹åˆ†æ•°
3. æŒ‰åˆ†æ•°æ’åºå–Top20
4. ä¸çœŸå®Top20å¯¹æ¯”è¯„ä¼°

### è¯„ä¼°æŒ‡æ ‡
- **Recall@K**: Top Ké¢„æµ‹ä¸­å®é™…æ­£æ ·æœ¬çš„æ¯”ä¾‹(æœ€é‡è¦æŒ‡æ ‡)
- **NDCG@K**: å½’ä¸€åŒ–æŠ˜æŸç´¯è®¡å¢ç›Š(æ’åºè´¨é‡)
- **Precision@K**: Top Ké¢„æµ‹çš„ç²¾ç¡®ç‡

---

## ğŸ—‚ï¸ æ•°æ®æ–‡ä»¶è¯´æ˜

### æ•°æ®ç»“æ„
```
recall/
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ local_migration_data.db              # äººå£æµåŠ¨æ•°æ®åº“(DuckDBæ ¼å¼)
â”‚   â”œâ”€â”€ cities_2000-2020/                   # å¹´åº¦åŸå¸‚ç‰¹å¾ç›®å½•
â”‚   â”‚   â”œâ”€â”€ cities_2000.jsonl              # 2000å¹´åŸå¸‚ç‰¹å¾
â”‚   â”‚   â”œâ”€â”€ cities_2001.jsonl              # 2001å¹´åŸå¸‚ç‰¹å¾
â”‚   â”‚   â”œâ”€â”€ ...
â”‚   â”‚   â””â”€â”€ cities_2020.jsonl              # 2020å¹´åŸå¸‚ç‰¹å¾
â”‚   â”œâ”€â”€ city_edges.jsonl                     # åŸå¸‚é—´è·ç¦»å…³ç³»
â”‚   â””â”€â”€ city_nodes.jsonl                     # åŸå¸‚åŸºæœ¬ä¿¡æ¯
â”œâ”€â”€ output/                                   # è¾“å‡ºç›®å½•
â”‚   â””â”€â”€processed_ready                      # æœ‰2000-2020é¢„å¤„ç†åçš„parquet
â””â”€â”€ src/                                      # æºä»£ç 
```

### æ•°æ®åº“è·¯å¾„é…ç½®
å·²åœ¨ `src/config.py` ä¸­é…ç½®ä¸º:
- **æ•°æ®åº“**: `/data1/wxj/Recall_city_project/data/local_migration_data.db`
- **å¹´åº¦åŸå¸‚æ•°æ®**: `/data1/wxj/Recall_city_project/data/cities_2000-2020/`

---

## ğŸš€ ä»é›¶å¼€å§‹å®Œæ•´æµç¨‹

### æ­¥éª¤1: ç¯å¢ƒè®¾ç½® âœ…

å·²å®Œæˆ:
```bash
# 1. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
uv venv

# 2. å®‰è£…ä¾èµ–
uv pip install -e .
```

å¦‚æœéœ€è¦é‡æ–°æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ:
```bash
# Windows (CMD)
.venv\Scripts\activate

# Windows (PowerShell)
.venv\Scripts\Activate.ps1
```

### æ­¥éª¤2: ç”Ÿæˆè®­ç»ƒæ•°æ®

è¿è¡Œä¸»ç¨‹åºç”Ÿæˆå¤„ç†åçš„è®­ç»ƒæ•°æ®:

```bash
uv run main.py
```

**è¿™ä¸€æ­¥ä¼šåšä»€ä¹ˆ:**
1. ä» DuckDB åŠ è½½åŸå§‹äººå£æµåŠ¨æ•°æ®(2000-2020å¹´)
2. ä¸ºæ¯å¹´åŠ è½½å¯¹åº”çš„åŸå¸‚ç‰¹å¾æ•°æ®(ä¾‹å¦‚å¤„ç†2015å¹´æ•°æ®æ—¶ä½¿ç”¨cities_2015.jsonl)
3. ç”Ÿæˆæ··åˆè´Ÿæ ·æœ¬(30ä¸ªå›°éš¾è´Ÿæ ·æœ¬ + 30ä¸ªéšæœºè´Ÿæ ·æœ¬)
4. è¿›è¡Œç‰¹å¾å·¥ç¨‹(äººå£ç±»å‹ç‰¹å¾ã€åŸå¸‚ç‰¹å¾ã€å†å²ç‰¹å¾)
5. ä¿å­˜å¤„ç†åçš„æ•°æ®åˆ° `output/processed_data/` ç›®å½•

**è¾“å‡ºæ–‡ä»¶:**
```
output/processed_data/
â”œâ”€â”€ processed_2000.parquet    # 2000å¹´æ•°æ®(ä»…ç”¨äºå†å²ç‰¹å¾)
â”œâ”€â”€ processed_2001.parquet
â”œâ”€â”€ ...
â””â”€â”€ processed_2020.parquet
```

**é¢„è®¡æ—¶é—´:** 10-30åˆ†é’Ÿ(å–å†³äºCPUæ€§èƒ½)

### æ­¥éª¤3: è®­ç»ƒæ¨¡å‹

è®­ç»ƒ LightGBM æ¨¡å‹:

```bash
# CPUè®­ç»ƒ(å®Œæ•´æ•°æ®: 2001-2017è®­ç»ƒ, 2018éªŒè¯, 2019-2020æµ‹è¯•)
uv run train.py

# å¿«é€Ÿæµ‹è¯•(è®­ç»ƒåˆ°2010å¹´)
uv run train.py --end_year 2010

# GPUè®­ç»ƒ(éœ€è¦å®‰è£… lightgbm-gpu)
uv run train.py --gpu

# GPUè®­ç»ƒ + å¿«é€Ÿæµ‹è¯•
uv run train.py --end_year 2010 --gpu
```

**è®­ç»ƒå‚æ•°è¯´æ˜:**
- `--end_year`: è®­ç»ƒæˆªæ­¢å¹´ä»½(é»˜è®¤2020)
  - è‡ªåŠ¨åˆ’åˆ†: è®­ç»ƒé›†(2001 åˆ° end_year-3), éªŒè¯é›†(end_year-2), æµ‹è¯•é›†(end_year-1 åˆ° end_year)
- `--gpu`: å¯ç”¨GPUåŠ é€Ÿè®­ç»ƒ

**è¾“å‡ºæ–‡ä»¶:**
```
output/
â”œâ”€â”€ lgb_model_2017.txt                 # è®­ç»ƒå¥½çš„æ¨¡å‹
â”œâ”€â”€ training_history.png               # è®­ç»ƒæ›²çº¿å›¾
â”œâ”€â”€ feature_importance.png             # ç‰¹å¾é‡è¦æ€§å›¾
â””â”€â”€ training_metrics.txt              # è®­ç»ƒæŒ‡æ ‡è®°å½•
```

**é¢„è®¡æ—¶é—´:**
- CPU: 30-60åˆ†é’Ÿ
- GPU: 10-20åˆ†é’Ÿ

### æ­¥éª¤4: è¯„ä¼°æ¨¡å‹

è¯„ä¼°æ¨¡å‹æ€§èƒ½å¹¶æŸ¥çœ‹å¬å›æ•ˆæœ:

```bash
uv run evaluate.py
```

**è¿™ä¸€æ­¥ä¼šåšä»€ä¹ˆ:**
1. åŠ è½½è®­ç»ƒå¥½çš„æ¨¡å‹
2. åœ¨æµ‹è¯•é›†(2019-2020å¹´)ä¸Šè¯„ä¼°
3. è®¡ç®—å¬å›ç‡@Kã€NDCG@Kç­‰æŒ‡æ ‡
4. ç”Ÿæˆè¯¦ç»†çš„è¯„ä¼°æŠ¥å‘Š

**è¾“å‡º:**
- æ§åˆ¶å°æ‰“å°è¯„ä¼°æŒ‡æ ‡
- å„å¹´ä»½çš„è¯¦ç»†æ€§èƒ½åˆ†æ

**å…³é”®æŒ‡æ ‡:**
- **Recall@K**: Top Ké¢„æµ‹ä¸­å®é™…æ­£æ ·æœ¬çš„æ¯”ä¾‹
- **NDCG@K**: å½’ä¸€åŒ–æŠ˜æŸç´¯è®¡å¢ç›Š
- **Precision@K**: Top Ké¢„æµ‹çš„ç²¾ç¡®ç‡

### æ­¥éª¤5: (å¯é€‰) é¢„å¤„ç†é™æ€ç‰¹å¾

å¦‚æœè¦ä½¿ç”¨é™æ€ç‰¹å¾ä¼˜åŒ–(å¯é€‰):

```bash
uv run evaluate_pre.py
```

---

## ğŸ“Š æŸ¥çœ‹Recallæ•ˆæœ

### è¯„ä¼°æŒ‡æ ‡è¯´æ˜

è¿è¡Œ `uv run evaluate.py` åï¼Œä½ ä¼šçœ‹åˆ°ç±»ä¼¼ä»¥ä¸‹è¾“å‡º:

```
========================================
å¼€å§‹è¯„ä¼°å¹´ä»½: 2010
========================================
Step 1: åŠ è½½æµ‹è¯•é›† Ground Truth...      
[SQL] Loaded 357600 rows
[Wide-to-Long] Generated 3153120 positive samples
[Negative Sampling] Added 292616 negative samples (Target: 1 per query)
[Final] Total: 3445736 rows
âš ï¸ è¿›è¡Œé‡‡æ ·è¯„ä¼°: 1000/302873
Step 2: ç”Ÿæˆå€™é€‰é›† (1000 Queries x 337 Cities)...
å€™é€‰é›†å¤§å°: 336,000 è¡Œ
Step 3: ç‰¹å¾å·¥ç¨‹...
Step 4: æ¨¡å‹æ‰“åˆ†...
Step 5: è®¡ç®—è¯„ä¼°æŒ‡æ ‡...

========================================
ğŸ“Š è¯„ä¼°ç»“æœæŠ¥å‘Š (2010)
========================================
Queryæ ·æœ¬æ•° : 302873
å¹³å‡æ­£æ ·æœ¬æ•° : 10.41
------------------------------
Recall@1   : 0.01%
Recall@5   : 0.06%
Recall@10  : 0.10%
Recall@20  : 0.16%
========================================
```

### æŒ‡æ ‡è§£è¯»

1. **Recall@K**: æ¨¡å‹é¢„æµ‹çš„Top Kä¸ªåŸå¸‚ä¸­ï¼Œæœ‰å¤šå°‘æ˜¯çœŸå®çš„ç›®æ ‡åŸå¸‚
   - Recall@10 = 0.85 è¡¨ç¤º: åœ¨é¢„æµ‹çš„å‰10ä¸ªåŸå¸‚ä¸­ï¼Œå¹³å‡èƒ½æ‰¾åˆ°85%çš„çœŸå®ç›®æ ‡åŸå¸‚
   - è¿™æ˜¯**æœ€é‡è¦çš„æŒ‡æ ‡**ï¼Œè¡¡é‡å¬å›èƒ½åŠ›

2. **NDCG@K**: è€ƒè™‘æ’åä½ç½®çš„è´¨é‡æŒ‡æ ‡
   - è¶Šæ¥è¿‘1è¶Šå¥½ï¼Œè¡¨ç¤ºæ’åºè´¨é‡é«˜
   - çœŸå®ç›®æ ‡åŸå¸‚æ’åœ¨è¶Šå‰é¢ï¼ŒNDCGè¶Šé«˜

3. **Precision@K**: Top Ké¢„æµ‹çš„å‡†ç¡®ç‡
   - Precision@10 = 0.086 è¡¨ç¤º: Top 10é¢„æµ‹ä¸­ï¼Œå¹³å‡æœ‰8.6%æ˜¯æ­£ç¡®çš„

### å¯è§†åŒ–ç»“æœ

è®­ç»ƒå®Œæˆåï¼ŒæŸ¥çœ‹ç”Ÿæˆçš„å›¾è¡¨:

1. **è®­ç»ƒæ›²çº¿** (`output/training_history.png`)
   - æ˜¾ç¤ºè®­ç»ƒé›†å’ŒéªŒè¯é›†çš„LogLosså˜åŒ–
   - ç”¨äºåˆ¤æ–­æ˜¯å¦è¿‡æ‹Ÿåˆ

2. **ç‰¹å¾é‡è¦æ€§** (`output/feature_importance.png`)
   - æ˜¾ç¤ºå“ªäº›ç‰¹å¾å¯¹é¢„æµ‹æœ€é‡è¦
   - å¸®åŠ©ç†è§£æ¨¡å‹å†³ç­–

---

## ğŸ”§ å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•åªå¤„ç†æŸå‡ å¹´çš„æ•°æ®?

ä¿®æ”¹ `src/config.py` ä¸­çš„é…ç½®:
```python
DATA_START_YEAR = 2000  # èµ·å§‹å¹´ä»½
TRAIN_START_YEAR = 2001  # è®­ç»ƒèµ·å§‹å¹´ä»½
TRAIN_END_YEAR = 2017    # è®­ç»ƒç»“æŸå¹´ä»½
VAL_YEARS = [2018]       # éªŒè¯å¹´ä»½
TEST_YEARS = [2019, 2020]  # æµ‹è¯•å¹´ä»½
```

æˆ–ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°:
```bash
uv run train.py --end_year 2015  # åªè®­ç»ƒåˆ°2015å¹´
```

### Q2: å†…å­˜ä¸è¶³æ€ä¹ˆåŠ?

å¦‚æœå†…å­˜ä¸è¶³ï¼Œå¯ä»¥:
1. å‡å°‘è´Ÿæ ·æœ¬æ•°é‡(`Config.NEG_SAMPLE_RATE`ä»60æ”¹ä¸º30)
2. å‡å°‘è®­ç»ƒå¹´ä»½èŒƒå›´
3. ä½¿ç”¨ `--end_year` å‚æ•°å‡å°‘æ•°æ®é‡

### Q3: å¦‚ä½•ä½¿ç”¨GPUè®­ç»ƒ?

1. ç¡®ä¿å®‰è£…äº†GPUç‰ˆæœ¬çš„LightGBM:
```bash
uv pip install lightgbm --gpu
```

2. æ·»åŠ  `--gpu` å‚æ•°:
```bash
uv run train.py --gpu
```

### Q4: æ•°æ®å·²ç»å¤„ç†è¿‡äº†ï¼Œå¦‚ä½•è·³è¿‡?

`main.py` ä¼šè‡ªåŠ¨è·³è¿‡å·²å­˜åœ¨çš„å¹´ä»½:
```
Year 2015: Already processed, skipping
```

å¦‚éœ€é‡æ–°å¤„ç†ï¼Œåˆ é™¤å¯¹åº”æ–‡ä»¶:
```bash
rm output/processed_data/processed_2015.parquet
```

### Q5: å¹´åº¦åŸå¸‚æ•°æ®åŠ è½½å¤±è´¥?

ç¡®ä¿ä»¥ä¸‹è·¯å¾„æ­£ç¡®:
- åŸå¸‚æ•°æ®ç›®å½•: `/data1/wxj/Recall_city_project/data/cities_2000-2020/`
- å¹´åº¦æ–‡ä»¶æ ¼å¼: `cities_2000.jsonl`, `cities_2001.jsonl`, ..., `cities_2020.jsonl`

æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨:
```bash
ls data/cities_2000-2020/
```

---

## ğŸ“ ä»£ç å˜æ›´è¯´æ˜

### ä¿®æ”¹çš„æ–‡ä»¶

1. **src/config.py**
   - æ›´æ–°æ•°æ®åº“è·¯å¾„ä¸ºç»å¯¹è·¯å¾„
   - æ·»åŠ å¹´åº¦åŸå¸‚æ•°æ®ç›®å½•é…ç½® `CITY_INFO_DIR`

2. **src/city_data.py**
   - `CityDataLoader.city_info` ä» DataFrame æ”¹ä¸ºå­—å…¸ `{year: DataFrame}`
   - `load_city_info()` æ”¯æŒæŒ‰å¹´ä»½åŠ è½½
   - æ–°å¢ `get_city_info_for_year(year)` æ–¹æ³•
   - `get_city_attributes()` æ”¯æŒæŒ‡å®šå¹´ä»½

3. **src/feature_pipeline.py**
   - `FeaturePipeline` åœ¨transformæ—¶æ ¹æ®Yearåˆ—è‡ªåŠ¨è·å–å¯¹åº”å¹´ä»½çš„åŸå¸‚ä¿¡æ¯
   - ç¡®ä¿ç‰¹å¾å·¥ç¨‹ä½¿ç”¨æ­£ç¡®å¹´ä»½çš„åŸå¸‚ç‰¹å¾

4. **main.py**
   - åŠ è½½æ‰€æœ‰å¹´ä»½(2000-2020)çš„åŸå¸‚æ•°æ®
   - ä½¿ç”¨2010å¹´æ•°æ®ä½œä¸ºå›°éš¾è´Ÿæ ·æœ¬å€™é€‰æ± åŸºå‡†

### ä¸éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

- `src/data_loader.py` - æ•°æ®åŠ è½½é€»è¾‘ä¸å˜
- `src/feature_eng.py` - ç‰¹å¾å·¥ç¨‹é€»è¾‘ä¸å˜
- `src/historical_features.py` - å†å²ç‰¹å¾é€»è¾‘ä¸å˜
- `train.py` - è®­ç»ƒé€»è¾‘ä¸å˜
- `evaluate.py` - è¯„ä¼°é€»è¾‘ä¸å˜

---

## ğŸ¯ ä¸‹ä¸€æ­¥

1. **è¿è¡Œå®Œæ•´æµç¨‹:**
   ```bash
   uv run main.py      # ç”Ÿæˆæ•°æ®(é¦–æ¬¡è¿è¡Œ)
   uv run train.py     # è®­ç»ƒæ¨¡å‹
   uv run evaluate.py  # è¯„ä¼°æ•ˆæœ
   ```

2. **æŸ¥çœ‹ç»“æœ:**
   - æ£€æŸ¥ `output/` ç›®å½•ä¸‹çš„æ¨¡å‹å’Œå›¾è¡¨
   - æŸ¥çœ‹ Recall@10 æŒ‡æ ‡æ˜¯å¦è¾¾åˆ°é¢„æœŸ(>0.8)

3. **ä¼˜åŒ–æ¨¡å‹:**
   - è°ƒæ•´ `Config.LGBM_PARAMS` ä¸­çš„è¶…å‚æ•°
   - å°è¯•ä¸åŒçš„ç‰¹å¾ç»„åˆ
   - å¢åŠ è®­ç»ƒæ•°æ®é‡

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œæ£€æŸ¥:
1. Pythonç‰ˆæœ¬ >= 3.11
2. æ‰€æœ‰ä¾èµ–å·²å®‰è£…: `uv pip list`
3. æ•°æ®æ–‡ä»¶è·¯å¾„æ­£ç¡®
4. è™šæ‹Ÿç¯å¢ƒå·²æ¿€æ´»

ç¥è®­ç»ƒé¡ºåˆ©! ğŸ‰
